#!/usr/bin/env bash

set -Eeuo pipefail

trap cleanup SIGINT SIGTERM ERR

tmp_download_dir=$(mktemp -d)

cleanup() {
  trap - SIGINT SIGTERM ERR
  rm -rf "$ASDF_INSTALL_PATH" "$tmp_download_dir"
  echo
  echo -e "\e[33mCleanup:\e[m Something went wrong!"
  echo
  echo "$(caller): ${BASH_COMMAND}"
}

fail() {
  echo -e "\e[31mFail:\e[m $*"
  exit 1
}

install_rlwrap() {
  local install_type=$1
  local version=$2
  local install_path=$3

  if [ "$install_type" != "version" ]; then
    fail "asdf-rlwrap supports release installs only"
  fi

  local download_url="https://github.com/hanslub42/rlwrap/archive/v${version}.tar.gz"
  local file_name="rlwrap-${version}.tar.gz"

  local source_path="${tmp_download_dir}/${file_name}"
  local distination="${tmp_download_dir}/dist"

  echo "âˆ— Downloading rlwrap source..."
  curl --silent --location --create-dirs --output "$source_path" "$download_url"
  mkdir -p "$distination"
  tar zxf "$source_path" -C "$distination" --strip-components=1
  cd "$distination"
  autoreconf --install
  case "$OSTYPE" in
    darwin*)
      CPPFLAGS="-I$(brew --prefix readline)/include" \
      CFLAGS="-I$(brew --prefix readline)/include" \
      LDFLAGS="-L$(brew --prefix readline)/lib" \
        ./configure --prefix="$install_path"
      ;;
    linux*)
      ./configure --prefix="$install_path"
      ;;
    *)
      fail "Unsupported platform..."
      ;;
  esac
  make &>log.make
  make install
  echo "The installation was successful!"
}

install_rlwrap "$ASDF_INSTALL_TYPE" "$ASDF_INSTALL_VERSION" "$ASDF_INSTALL_PATH"
